<html>

<head>
    <script>
        // The database of articles
        let db = [
            {
                id: 11,
                article: "programming is great",
                name: "programming article 11",
                tags: ["progamming"]
            },
            {
                id: 12,
                article: "programming is great",
                name: "programming article 12",
                tags: ["progamming"]
            },
            {
                id: 13,
                article: "programming is great",
                name: "programming article 13",
                tags: ["progamming"]
            },
            {
                id: 14,
                article: "programming is great",
                name: "programming article 14",
                tags: ["progamming"]
            },
            {
                id: 15,
                article: "programming is great",
                name: "programming article 15",
                tags: ["progamming"]
            },
            {
                id: 16,
                article: "programming is great",
                name: "programming article 16",
                tags: ["progamming"]
            },
            {
                id: 17,
                article: "programming is great",
                name: "programming article 17",
                tags: ["progamming"]
            },
            {
                id: 18,
                article: "programming is great",
                name: "programming article 18",
                tags: ["progamming"]
            },
            {
                id: 19,
                article: "programming is great",
                name: "programming article 19",
                tags: ["progamming", "life"]
            },
            {
                id: 20,
                article: "programming is great",
                name: "programming article 20",
                tags: ["progamming"]
            },
            {
                id: 21,
                article: "programming is great",
                name: "programming article 21",
                tags: ["progamming"]
            },
            {
                id: 22,
                article: "programming is great",
                name: "programming article 22",
                tags: ["progamming"]
            },
            {
                id: 23,
                article: "programming is great",
                name: "programming article 23",
                tags: ["progamming"]
            },
            {
                id: 24,
                article: "programming is great",
                name: "programming article 24",
                tags: ["progamming"]
            },
            {
                id: 25,
                article: "programming is great",
                name: "programming article 25",
                tags: ["progamming"]
            },
            {
                id: 26,
                article: "programming is great",
                name: "programming article 26",
                tags: ["progamming"]
            },
            {
                id: 27,
                article: "programming is great",
                name: "programming article 27",
                tags: ["progamming"]
            },
            {
                id: 28,
                article: "programming is great",
                name: "programming article 28",
                tags: ["progamming"]
            },
            {
                id: 29,
                article: "programming is great",
                name: "programming article 29",
                tags: ["progamming"]
            },
            {
                id: 30,
                article: "programming is great",
                name: "programming article 30",
                tags: ["progamming"]
            },
            {
                id: 31,
                article: "programming is great",
                name: "programming article 31",
                tags: ["progamming"]
            },
        ];

        // Load db from localStorage
        function loadDb () {
            if (localStorage.getItem('database') !== null) {
                db = JSON.parse(localStorage.getItem('database'));
            }
        }
        loadDb();
        </script>

    <style>
        body {
            background-color: rgb(154, 189, 189);
        }
        </style>
</head>

<body>
    <div style="display: grid; grid-template-columns: [first] 300px [content] auto [last] 300px [end];">
        <h1 style="grid-column: content">Hello World. </h1>
        <div id="articles" style="grid-column: content"></div>
</div>
<div id="outer">
    <div id="inner"; style="position: relative; left: 300px;">
        <input type="button" class="navButton" id="first" onclick="firstPage()" value="first" />
        <input type="button" class="navButton" id="previous" onclick="previousPage()" value="previous" />
        <input type="button" class="navButton" id="next" onclick="nextPage()" value="next" />
        <input type="button" class="navButton" id="last" onclick="lastPage()" value="last" />
    </div>
</div>

<script>
    // Pagination
    let currentPage = 1;
    let numberPerPage = 5;
    let numberOfPages = 1;
    let pageList = [];

    function getNumberOfPages() {
        return Math.ceil(db.length / numberPerPage)
    }
    
    function nextPage() {
        currentPage += 1;
        loadList();
        checkTheHash();
    }

    function previousPage() {
        currentPage -= 1;
        loadList();
        checkTheHash();
    }
    
    function firstPage() {
        currentPage = 1;
        loadList();
        checkTheHash();
    }

    function lastPage() {
        currentPage = numberOfPages;
        loadList();
        checkTheHash();
    }

    function check() {
        document.getElementById("first").disabled = currentPage == 1 ? true : false;
        document.getElementById("previous").disabled = currentPage == 1 ? true : false;
        document.getElementById("next").disabled = currentPage == numberOfPages ? true : false;
        document.getElementById("last").disabled = currentPage == numberOfPages ? true : false;
    }

    function loadList() {
        pageList = [];
        numberOfPages = getNumberOfPages();
        let begin = ((currentPage - 1) * numberPerPage);
        let end = begin + numberPerPage;
        for (let article in db.slice(begin, end)) {
            pageList.push(db.slice(begin, end)[article]);            
        }
        check();
        return pageList;
    }
    loadList();

    // Save to localStorage
    function populateStorage() {
        localStorage.setItem('database', JSON.stringify(db));
        let myDb = JSON.parse(localStorage.getItem('database'));
    }
    
    // Check the window.location.hash to determine what page to show
    function checkTheHash() {
        if (window.location.hash == "") {
            let articleList = new ArticleApp(pageList);
            articleList.render();
        }
        
        let articleIndex = "";
        db.forEach(function(art, index) {
            if (art.id == window.location.hash.slice(1)) {
                articleIndex = index
            } 
        })
        
        if (window.location.hash.endsWith("edit")) {
            let artId = window.location.hash.slice(1, 3);
            let editApp = new ArticleApp
            
            // How did we find this last time???
            let art = "";
            for (let article in db) {
                if (db[article].id == artId) {
                    art = db[article]
                }
            }
            editApp.onEditClick(art)
        }

        if (db[articleIndex] !== undefined) {
            detailEl = new Article(db[articleIndex]).render()
            let articlesSelector = document.querySelector('#articles');
            articlesSelector.innerHTML = "";
            articlesSelector.append(detailEl);
        }
    }

    // Listen for hashchange
    window.addEventListener("hashchange", checkTheHash);
    

    class Article {
        constructor(article, onBackClick, onEditClick) {
            this.article = article;
            this.onBackClick = onBackClick;
            this.onEditClickLocal = onEditClick;
        }
        
        // Render an individual article
        render() {

            document.getElementById('inner').style.display = 'none'; // Hide the nav bar when going to article

            let detailEl = document.createElement('p');

            detailEl.innerHTML = `
            <h2>Article #${this.article.id} ${this.article.name}</h2>
            <p>${this.article.article}</p>
            <p>${this.article.tags}</p>
            <p><button id="edit">Edit</button></p>
            <p><button id="back">Back</button></p>
            `
            detailEl.querySelector('#edit').onclick = (ev => {
                window.location.hash = this.article.id + "edit";

            })
            
            detailEl.querySelector('#back').onclick = (ev => {
                window.location.hash = "";

            })

            return detailEl

        }
    }

    class ArticleApp {
        constructor(articles) {
            this.el_tag = document.querySelector('#articles');
            this.articles = articles;

        }

        render() {
            this.el_tag.innerHTML = ""
            let res = [];
            this.articles.forEach(art => {
                let el = document.createElement('p');
                el.innerHTML = `<a href="#${art.id}">${art.name}</a>`
                res.push(el)
            });

            res.forEach(el => {
                this.el_tag.append(el)
            })
            
            
            document.getElementById('inner').style.display = 'block'; // Show the navigation if display is 'none'
        }


        onEditClick(art) {
            // input for each field(name, article, tags)
            // onSave button (take value of each input and put it into the article)
            // render the page again with updated fields
            this.el_tag.innerHTML = ""
            
            let user_editable = ["name", "article", "tags"];
            user_editable.forEach(editable => {
                let el = document.createElement('p');
                el.innerHTML = `<input type="text" id="${editable}" value="${art[editable]}">`
                // replace this with localStorage value    
                this.el_tag.append(el)
            })
            let saveButton = document.createElement('p');
            saveButton.innerHTML = "<p><button class='button' id='save'>Save</button></p>"
            this.el_tag.append(saveButton);

            let backButton = document.createElement('p');
            backButton.innerHTML = "<p><button class='button' id='back'>back</button></p>"
            this.el_tag.append(backButton);
            
            saveButton.querySelector('#save').onclick = (ev => {
                let newName = document.getElementById('name').value;
                let newArticle = document.getElementById('article').value;
                let newTags = document.getElementById('tags').value;
                
                let newTagsArr = newTags.split(" ");
                for (let tag in newTagsArr) {
                    if (newTagsArr[tag][0] != "#") {
                        newTagsArr[tag] = "#" + newTagsArr[tag]
                    }
                }

                art.name = newName
                art.article = newArticle
                art.tags = newTagsArr
                window.location.hash = art.id

                populateStorage();

            })

            backButton.querySelector('#back').onclick = (ev => {
                    window.location.hash = art.id;
            })
        
        }

    }
    
    checkTheHash();

</script>
</body>

</html>